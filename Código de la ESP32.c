// ================================================================= //
//               1. INCLUSIÓN DE BIBLIOTECAS
// ================================================================= //
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <ESPAsyncWebServer.h>
#include <EEPROM.h>
#include "SPIFFS.h"
#include <ArduinoJson.h>


// ================================================================= //
//               2. DEFINICIONES Y CONSTANTES
// ================================================================= //

// --- Display ---
#define OLED_RESET 13 
#if (SSD1306_LCDHEIGHT != 32)
#error("Altura incorrecta, cambie en la librería de Adafruit_SSD1306.h!");
#endif

// --- Pines ---
const int PinGlucosa = 7;     // Pin para la lectura de glucosa (GPIO1)
const int push = 8;      // Pin para el botón de interrupción (GPIO2)
// --- Almacenamiento (EEPROM) ---
#define EEPROM_SIZE   512     // Tamaño total de EEPROM a reservar (en bytes)
#define ADDR_SSID     0       // Dirección para guardar SSID (reservamos 64 bytes)
#define ADDR_PASSWORD 64      // Dirección para guardar Password (reservamos 64 bytes)
#define ADDR_NAME     128     // Dirección para guardar Nombre (reservamos 64 bytes)
#define ADDR_MODO     192     // Dirección para guardar el modo de operación (reservamos 16 bytes)


// ================================================================= //
//               3. OBJETOS GLOBALES
// ================================================================= //
Adafruit_SSD1306 display(OLED_RESET);
AsyncWebServer server(80);
AsyncWebSocket ws("/ws");
// Preferences preferences; // <-- ELIMINADO


// ================================================================= //
//               4. VARIABLES GLOBALES
// ================================================================= //

// --- Datos de Usuario y WiFi ---
String userName;
String userSSID = "IZZI-06DF";      // Valor inicial (será reemplazado por EEPROM)
String userPassword = "uDATyyAg";   // Valor inicial (será reemplazado por EEPROM)
bool modo = false;                   // Modo de operación (AP o STA)

// --- Control de Flujo y Botón ---
bool buttonState = false;
bool banderaProceso = false;        //
unsigned long lastDebounceTime = 0;
int displayTimer = 0; int sleepTimer = 0;
unsigned long tiempoActual = 0;
volatile boolean START = false;     //

// --- Medición Glucosa ---
float Vglucosa = 0;
float x = 0;
int glucosa = 0;
int glucosaCuadratica = 0;
float lecturaActual = 0;            //


// ================================================================= //
//               5. RECURSOS GRÁFICOS (BITMAPS)
// ================================================================= //
static const uint8_t glucoStream[] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x01, 0xb8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0x80, 0x0f, 0xb7, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x80, 0x1f, 0x6f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0x00, 0x3f, 0x6f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0x00, 0x7e, 0xdf, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xfe, 0x00, 0xfe, 0xdf, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0xfc, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xfb, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 0xf4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf8, 0x20, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf8, 0x30, 0x00, 0xeb, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x70, 0x00, 0xeb, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x7b, 0xfe, 0x47, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0xf9, 0xfe, 0x17, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0xfc, 0xfe, 0x0f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0xfc, 0x7e, 0x6f, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0xfc, 0x7e, 0x07, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf8, 0xfc, 0x7e, 0x80, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xf8, 0x78, 0x7e, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x20, 0x7e, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x7e, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x01, 0xfe, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xfe, 0x0f, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xfe, 0x1f, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xfe, 0x1f, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xfe, 0x3f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xfe, 0x7f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xfe, 0x7f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x3c, 0x7f, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};
static const uint8_t afterPush[] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x80, 0x00, 0x0f, 0xff, 0xc0, 0x00, 
0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x01, 0x80, 0x00, 0x1f, 0xff, 0xc0, 0x00, 
0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x1c, 0x00, 0xe0, 0x00, 
0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x38, 0x00, 0x60, 0x00, 
0x00, 0x00, 0x03, 0xf0, 0x00, 0x00, 0x1f, 0x80, 0x00, 0x07, 0xe0, 0x00, 0x38, 0x00, 0x60, 0x00, 
0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x07, 0xf0, 0x00, 0x38, 0x20, 0x60, 0x00, 
0x00, 0x00, 0x07, 0xf8, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x0f, 0xf0, 0x00, 0x38, 0x30, 0x60, 0x00, 
0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x0f, 0xf8, 0x00, 0x38, 0x30, 0x60, 0x00, 
0x00, 0x00, 0x0f, 0xfc, 0x00, 0x00, 0xff, 0xe0, 0x00, 0x1f, 0xf8, 0x00, 0x38, 0x00, 0x60, 0x00, 
0x00, 0x00, 0x1f, 0xfc, 0x00, 0x00, 0xff, 0xe0, 0x00, 0x1f, 0xfc, 0x00, 0x38, 0x00, 0x60, 0x00, 
0x00, 0x00, 0x1f, 0xfe, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x3f, 0xfc, 0x00, 0x3c, 0x00, 0xe0, 0x00, 
0x00, 0x00, 0x3f, 0xfe, 0x00, 0x01, 0xff, 0xf0, 0x00, 0x3f, 0xfe, 0x00, 0x3f, 0xff, 0xe0, 0x00, 
0x00, 0x00, 0x3f, 0xff, 0x00, 0x01, 0xff, 0xf0, 0x00, 0x3f, 0xfe, 0x00, 0x3f, 0xff, 0xe0, 0x00, 
0x00, 0x00, 0x7f, 0xff, 0x00, 0x03, 0xff, 0xf8, 0x00, 0x7f, 0xfe, 0x00, 0x3f, 0xff, 0xe0, 0x00, 
0x00, 0x00, 0x7f, 0xff, 0x00, 0x03, 0xff, 0xf8, 0x00, 0x7f, 0xff, 0x00, 0x3f, 0xff, 0xe0, 0x00, 
0x00, 0x00, 0xff, 0xff, 0x80, 0x07, 0xff, 0xfc, 0x00, 0xff, 0xff, 0x00, 0x3f, 0xff, 0xe0, 0x00, 
0x00, 0x00, 0xff, 0xff, 0x80, 0x07, 0xff, 0xfc, 0x00, 0xff, 0xff, 0x80, 0x3c, 0x78, 0xe0, 0x00, 
0x00, 0x00, 0xff, 0xff, 0xc0, 0x07, 0xff, 0xfc, 0x01, 0xff, 0xff, 0x80, 0x3c, 0x70, 0xe0, 0x00, 
0x00, 0x01, 0xff, 0xff, 0xc0, 0x0f, 0xff, 0xfe, 0x01, 0xff, 0xff, 0x80, 0x3c, 0x78, 0xe0, 0x00, 
0x00, 0x01, 0xff, 0xff, 0xc0, 0x0f, 0xff, 0xfe, 0x01, 0xff, 0xff, 0xc0, 0x1f, 0xff, 0xe0, 0x00, 
0x00, 0x01, 0xff, 0xff, 0xe0, 0x0f, 0xff, 0xfe, 0x01, 0xff, 0xff, 0xc0, 0x1f, 0xff, 0xe0, 0x00, 
0x00, 0x01, 0xef, 0xff, 0xe0, 0x0f, 0x7f, 0xfe, 0x03, 0xff, 0xff, 0xc0, 0x0f, 0xb7, 0xc0, 0x00, 
0x00, 0x01, 0xef, 0xff, 0xe0, 0x0f, 0x7f, 0xfe, 0x03, 0xcf, 0xff, 0xc0, 0x07, 0xff, 0x00, 0x00, 
0x00, 0x01, 0xef, 0xff, 0xc0, 0x0f, 0x7f, 0xfe, 0x03, 0xcf, 0xff, 0xc0, 0x00, 0x30, 0x00, 0x00, 
0x00, 0x01, 0xe7, 0xff, 0xc0, 0x0f, 0x3f, 0xfe, 0x01, 0xef, 0xff, 0xc0, 0x00, 0x30, 0x00, 0x00, 
0x00, 0x01, 0xf3, 0xff, 0xc0, 0x0f, 0x9f, 0xfe, 0x01, 0xe7, 0xff, 0xc0, 0x00, 0x30, 0x00, 0x00, 
0x00, 0x00, 0xf8, 0x7f, 0x80, 0x07, 0xc3, 0xfc, 0x01, 0xf1, 0xff, 0x80, 0x00, 0x30, 0x00, 0x00, 
0x00, 0x00, 0x7e, 0x7f, 0x80, 0x07, 0xf3, 0xfc, 0x00, 0xfc, 0x7f, 0x80, 0x00, 0x30, 0x00, 0x00, 
0x00, 0x00, 0x7f, 0xff, 0x00, 0x03, 0xff, 0xf8, 0x00, 0x7f, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0xfe, 0x00, 0x01, 0xff, 0xf0, 0x00, 0x3f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
};
static const uint8_t battery[] PROGMEM = {
0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x01, 0x80, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x08, 0x08, 0x08, 0x0e, 0x06, 0x00, 0x00, 0x00, 0x08, 0x08, 0x08, 0x1f, 0x8e, 0x00, 0x00, 0x00, 
0x08, 0x18, 0x08, 0x3b, 0x8c, 0x00, 0x00, 0x00, 0x08, 0x38, 0x08, 0x31, 0x9c, 0x00, 0x00, 0x00, 
0x08, 0x38, 0x08, 0x31, 0x98, 0x00, 0x00, 0x00, 0x08, 0x38, 0x08, 0x3f, 0xb8, 0x00, 0x00, 0x00, 
0x08, 0x7f, 0x88, 0x1f, 0x30, 0x00, 0x00, 0x00, 0x08, 0x7f, 0x88, 0x06, 0x30, 0x00, 0x00, 0x00, 
0x08, 0xff, 0x88, 0x00, 0x73, 0x80, 0x00, 0x00, 0x08, 0xff, 0x08, 0x00, 0x67, 0xc0, 0x00, 0x00, 
0x08, 0xff, 0x08, 0x00, 0xef, 0xe0, 0x00, 0x00, 0x08, 0x1e, 0x08, 0x00, 0xcc, 0x60, 0x00, 0x00, 
0x08, 0x1e, 0x08, 0x01, 0xcc, 0x60, 0x00, 0x00, 0x08, 0x1c, 0x08, 0x01, 0x8e, 0xe0, 0x00, 0x00, 
0x08, 0x1c, 0x08, 0x01, 0x87, 0xe0, 0x00, 0x00, 0x08, 0x18, 0x08, 0x03, 0x83, 0x80, 0x00, 0x00, 
0x08, 0x18, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x0f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};
static const uint8_t redConectada[] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xe0, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x3f, 0xf8, 0x0f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf0, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x7f, 0x80, 0x00, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x03, 0xf8, 0x00, 0x00, 0x0f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x07, 0xe0, 0x0f, 0xf8, 0x03, 0xf0, 0x00, 0x00, 0x00, 0x01, 0xff, 0xf0, 0x00, 0x00, 
0x00, 0x00, 0x07, 0xc0, 0x7f, 0xff, 0x01, 0xf8, 0x00, 0x00, 0x00, 0x03, 0xff, 0xe0, 0x00, 0x00, 
0x00, 0x00, 0x07, 0x81, 0xff, 0xff, 0xc0, 0x78, 0x00, 0x00, 0x00, 0x07, 0xff, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x06, 0x07, 0xff, 0xff, 0xf0, 0x30, 0x00, 0x00, 0x00, 0x0f, 0xff, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0f, 0xf0, 0x07, 0xf8, 0x00, 0x00, 0x60, 0x00, 0x1f, 0xff, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0xfc, 0x00, 0x00, 0xf0, 0x00, 0x3f, 0xfe, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x7e, 0x00, 0x01, 0xf8, 0x00, 0x7f, 0xfc, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x1f, 0x00, 0x03, 0xfc, 0x00, 0xff, 0xf8, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x38, 0x0f, 0xf8, 0x0f, 0x00, 0x07, 0xfe, 0x01, 0xff, 0xf0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x30, 0x3f, 0xfe, 0x06, 0x00, 0x0f, 0xff, 0x03, 0xff, 0xe0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0x80, 0x00, 0x07, 0xff, 0x87, 0xff, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xc0, 0x00, 0x07, 0xff, 0xcf, 0xff, 0x80, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0xf8, 0x0f, 0xc0, 0x00, 0x03, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x03, 0xe0, 0x03, 0xe0, 0x00, 0x01, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0xc0, 0x01, 0xe0, 0x00, 0x00, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x81, 0xc0, 0xc0, 0x00, 0x00, 0x7f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x03, 0xf0, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x07, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x03, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
};
static const uint8_t redDesconectada[] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x07, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x80, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x01, 0xc0, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x01, 0xff, 0x80, 0x1f, 0xf8, 0x00, 0x03, 0xe0, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x07, 0xf8, 0x00, 0x03, 0xfc, 0x00, 0x07, 0xf0, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x0f, 0xe0, 0x00, 0x00, 0xfe, 0x00, 0x0f, 0xf8, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0x80, 0x00, 0x00, 0x3f, 0x80, 0x1f, 0xfc, 0x00, 0xff, 0xe0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x3f, 0x00, 0xff, 0xe0, 0x1f, 0x80, 0x0f, 0xfe, 0x01, 0xff, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x7e, 0x07, 0xff, 0xfc, 0x07, 0xc0, 0x07, 0xff, 0x03, 0xff, 0x80, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x38, 0x1f, 0xff, 0xff, 0x03, 0xc0, 0x03, 0xff, 0x87, 0xff, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x10, 0x3f, 0xff, 0xff, 0x80, 0x00, 0x01, 0xff, 0xcf, 0xfe, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x7f, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xfc, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x7f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x01, 0xf8, 0x00, 0x01, 0xf8, 0x00, 0x00, 0x3f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x03, 0xe0, 0x1f, 0x00, 0xf8, 0x00, 0x00, 0x1f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x01, 0xc0, 0xff, 0xe0, 0x78, 0x00, 0x00, 0x0f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x07, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x07, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x07, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0f, 0xf1, 0xfe, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0f, 0x80, 0x3f, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0e, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x01, 0xff, 0xcf, 0xfe, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 0x00, 0x00, 0x03, 0xff, 0x87, 0xff, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x07, 0xff, 0x03, 0xff, 0x80, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x0f, 0xfe, 0x01, 0xff, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x1f, 0xfc, 0x00, 0xff, 0xe0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00,
};
static const uint8_t configuracion[] PROGMEM = {
0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 
0x00, 0x00, 0xe0, 0xfc, 0x1c, 0x00, 0x03, 0x07, 0xe0, 0xe0, 0x00, 0x18, 0x3f, 0x07, 0x00, 0x00, 
0x00, 0x01, 0xf1, 0xfe, 0x3e, 0x00, 0x07, 0x87, 0xe1, 0xf0, 0x00, 0x3c, 0x3f, 0x8f, 0x80, 0x00, 
0x00, 0x03, 0xff, 0xff, 0xff, 0x00, 0x0f, 0xff, 0xff, 0xf0, 0x00, 0x7f, 0xff, 0xff, 0xc0, 0x00, 
0x00, 0x03, 0xff, 0xff, 0xff, 0x00, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x7f, 0xff, 0xff, 0xc0, 0x00, 
0x00, 0x01, 0xff, 0xff, 0xfe, 0x00, 0x0f, 0xff, 0xff, 0xf0, 0x00, 0x7f, 0xff, 0xff, 0x80, 0x00, 
0x00, 0x00, 0xff, 0xff, 0xfc, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x3f, 0xff, 0xff, 0x00, 0x00, 
0x00, 0x00, 0x7f, 0xff, 0xf8, 0x00, 0x03, 0xff, 0xff, 0xc0, 0x00, 0x1f, 0xff, 0xfe, 0x00, 0x00, 
0x00, 0x00, 0x7f, 0x03, 0xf8, 0x00, 0x03, 0xfc, 0x1f, 0xc0, 0x00, 0x1f, 0xc0, 0xff, 0x00, 0x00, 
0x00, 0x00, 0xfe, 0x01, 0xfc, 0x00, 0x07, 0xf0, 0x0f, 0xe0, 0x00, 0x1f, 0x80, 0x3f, 0x00, 0x00, 
0x00, 0x01, 0xfc, 0x00, 0xfe, 0x00, 0x07, 0xe0, 0x07, 0xe0, 0x00, 0x7f, 0x00, 0x3f, 0x80, 0x00, 
0x00, 0x1f, 0xfc, 0x00, 0xff, 0xe0, 0xff, 0xe0, 0x07, 0xff, 0x07, 0xff, 0x00, 0x1f, 0xf8, 0x00, 
0x00, 0x1f, 0xf8, 0x00, 0x7f, 0xe0, 0xff, 0xc0, 0x03, 0xff, 0x07, 0xff, 0x00, 0x1f, 0xf8, 0x00, 
0x00, 0x1f, 0xf8, 0x00, 0x7f, 0xe0, 0xff, 0xc0, 0x03, 0xff, 0x07, 0xff, 0x00, 0x1f, 0xf8, 0x00, 
0x00, 0x1f, 0xf8, 0x00, 0x7f, 0xe0, 0xff, 0xc0, 0x03, 0xff, 0x07, 0xff, 0x00, 0x1f, 0xf8, 0x00, 
0x00, 0x1f, 0xfc, 0x00, 0xff, 0xe0, 0xff, 0xe0, 0x03, 0xff, 0x07, 0xff, 0x00, 0x1f, 0xf8, 0x00, 
0x00, 0x00, 0xfc, 0x00, 0xfc, 0x00, 0x0f, 0xe0, 0x07, 0xf0, 0x00, 0x3f, 0x00, 0x3f, 0x80, 0x00, 
0x00, 0x00, 0xfe, 0x01, 0xfc, 0x00, 0x07, 0xf0, 0x0f, 0xe0, 0x00, 0x1f, 0x80, 0x7f, 0x00, 0x00, 
0x00, 0x00, 0x7f, 0x03, 0xf8, 0x00, 0x03, 0xf8, 0x1f, 0xc0, 0x00, 0x1f, 0xe0, 0xff, 0x00, 0x00, 
0x00, 0x00, 0x7f, 0xff, 0xf8, 0x00, 0x03, 0xff, 0xff, 0xc0, 0x00, 0x1f, 0xff, 0xff, 0x00, 0x00, 
0x00, 0x00, 0xff, 0xff, 0xfc, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x3f, 0xff, 0xff, 0x00, 0x00, 
0x00, 0x01, 0xff, 0xff, 0xfe, 0x00, 0x0f, 0xff, 0xff, 0xf0, 0x00, 0x7f, 0xff, 0xff, 0x80, 0x00, 
0x00, 0x03, 0xff, 0xff, 0xff, 0x00, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x7f, 0xff, 0xff, 0xc0, 0x00, 
0x00, 0x01, 0xfb, 0xff, 0x7e, 0x00, 0x0f, 0xff, 0xff, 0xf8, 0x00, 0x7f, 0xff, 0xff, 0xc0, 0x00, 
0x00, 0x00, 0xf0, 0xfc, 0x3c, 0x00, 0x0f, 0x87, 0xf1, 0xf0, 0x00, 0x3c, 0x3f, 0x8f, 0x80, 0x00, 
0x00, 0x00, 0x60, 0xfc, 0x18, 0x00, 0x07, 0x07, 0xe0, 0xe0, 0x00, 0x18, 0x3f, 0x07, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00,
};

void glucometro();
void calculoGlucosa();
void peticionesHTTP();
void checkDebounceButton();
void timer();
void onWebSocketEvent(AsyncWebSocket *server, AsyncWebSocketClient *client, AwsEventType type, void *arg, uint8_t *data, size_t len);
void loadUserData();
void saveUserData(String name, String password, String ssid);
String getUserDataJson();
// ================================================================= //
//               6. FUNCIÓN DE CONFIGURACIÓN (SETUP)
// ================================================================= //
void setup() {
  Serial.begin(115200);

  // --- Inicializar EEPROM ---
  if (!EEPROM.begin(EEPROM_SIZE)) {
    Serial.println("¡Error al inicializar EEPROM!");
    while (1) delay(100); // Detener si falla
  }
  
  Serial.println("Glucometro XIAO ESP32-S3 listo. Pulse el botón.");

  // --- Inicializar Display ---
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  /*display.clearDisplay();
  display.drawBitmap(0, 0, battery, 64, 32, 1);
  display.setTextSize(3);
  display.setTextColor(WHITE);
  display.setCursor(64, 0);
  int num2 = 80; display.println(num2);
  display.display();*/
  // Mostrar logo
  display.clearDisplay();
  display.drawBitmap(0, 0, glucoStream, 128, 32, 1);
  display.display();
  delay(2000);

  // --- Configurar Pines ---
  pinMode(PinGlucosa, INPUT);
  analogSetPinAttenuation(PinGlucosa, ADC_11db); // Rango completo 0-3.3V
  pinMode(push, INPUT);

  // --- Carga de datos y SPIFFS ---
  loadUserData(); // Carga datos desde EEPROM
  
  // Leer el modo de operación desde EEPROM
  modo = EEPROM.readBool(ADDR_MODO);
  Serial.println(modo);
  // '0' significa que se despierta cuando el pin está en BAJO (presionado)
  esp_sleep_enable_ext0_wakeup(GPIO_NUM_8, 0);
  if (!modo) {
    // Modo Cliente (STA): Intentar conectar al WiFi guardado
    WiFi.begin(userSSID, userPassword);
  } else {
    // Modo Configuración (AP): Iniciar portal
    if (!SPIFFS.begin(true)) {
      Serial.println("Ocurrió un error al montar SPIFFS");
      return;
    }
    WiFi.softAP("GlucoStream");
    Serial.print("Dirección IP del AP: ");
    Serial.println(WiFi.softAPIP());
    
    ws.onEvent(onWebSocketEvent);
    server.addHandler(&ws);
    server.on("/", HTTP_GET, [](AsyncWebServerRequest *request) { request->send(SPIFFS, "/edit.html", "text/html"); });
    server.begin();
  }
  sleepTimer=60;
}


// ================================================================= //
//               7. BUCLE PRINCIPAL (LOOP)
// ================================================================= //
void loop() {
  if (!modo) {
    if (!START) {
      checkDebounceButton();

      if (displayTimer > 0 && displayTimer < 3) {
        banderaProceso = true;
        // Mostrar "Poner sangre"
        display.clearDisplay();
        display.drawBitmap(0, 0, afterPush, 128, 32, 1);
        display.display();
      } else if (displayTimer >= 3 && displayTimer < 10) {
        banderaProceso = false;
        if (WiFi.status() == WL_CONNECTED) {
          // Mostrar "Conectado"
          display.clearDisplay();
          display.drawBitmap(0, 0, redConectada, 128, 32, 1);
          display.display();
        } else {
          // Mostrar "Desconectado"
          display.clearDisplay();
          display.drawBitmap(0, 0, redDesconectada, 128, 32, 1);
          display.display();
        }
      } else if (displayTimer >= 10) {
        banderaProceso = false;
        // Entrar en modo Configuración (AP)
        Serial.println("Portal de Red");
        display.clearDisplay();
        display.drawBitmap(0, 0, configuracion, 128, 32, 1);
        display.display();
        
        EEPROM.writeBool(ADDR_MODO, true);
        EEPROM.commit();
        
        ESP.restart();
      }
    } else {
      glucometro();
    }
  }else{
    display.clearDisplay();
    display.drawBitmap(0, 0, configuracion, 128, 32, 1);
    display.display();
  }
  timer();
}


// ================================================================= //
//               8. FUNCIONES DE LÓGICA DE GLUCÓMETRO
// ================================================================= //

/*************************************************
 * Rutina de medicion del glucometro
 *************************************************/
void glucometro() {
  Serial.println("Esperando pico de tensión...");
  do {
    lecturaActual = analogRead(PinGlucosa);
    Vglucosa = (lecturaActual / 4095.0 * 3.3);
    Serial.print("Tension actual: "); Serial.println(Vglucosa, 4);
    timer();
  } while (Vglucosa < 0.7);

  Serial.println("Pico de tensión detectado. Iniciando medición...");
  
  // Mostrar "Calculando..."
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);
  display.println("Calculando");
  display.setCursor(20, 15);
  display.println("....");
  display.display();

  unsigned long tBegin = millis();
  unsigned long tEnd = 0;
  float sumaParcial = 0.0;
  int contadorDeMuestras = 0;

  Serial.print("experimento# = [");
  for (int i = 0; i < 1000; i++) {
    lecturaActual = analogRead(PinGlucosa);
    Vglucosa = (lecturaActual / 4095.0 * 3.3);
    Serial.print("; ");
    Serial.print(Vglucosa, 4);
    if (i >= 322 && i < 332) {
      sumaParcial = sumaParcial + Vglucosa;
      contadorDeMuestras++;
    }
    delayMicroseconds(8371);
  }
  Serial.println("];");
  tEnd = millis();
  Serial.print("Tiempo transcurrido: "); Serial.println(tEnd - tBegin);

  if (contadorDeMuestras > 0) {
    x = sumaParcial / contadorDeMuestras;
  } else {
    x = 0;
  }

  Serial.print("Voltaje promedio (x) [0-3.3V]: "); Serial.println(x, 4);

  calculoGlucosa();
  if(glucosa < 0){
    Serial.println("Error");
    // Mostrar resultado
    display.clearDisplay();
    display.setTextSize(4);
    display.setTextColor(WHITE);
    display.setCursor(20, 0);
    display.println("ERR");
    display.display();
    delay(3000);
    display.clearDisplay();
    display.display();
    esp_deep_sleep_start();
  }else{
    peticionesHTTP();
    // Mostrar resultado
    display.clearDisplay();
    display.setTextSize(4);
    display.setTextColor(WHITE);
    display.setCursor(20, 0);
    display.println(glucosa);
    display.display();
    delay(4000);
    
    START = false;
    Serial.println("Medición completa. Pulse el botón para iniciar de nuevo.");
  
    display.clearDisplay();
    display.display();
    esp_deep_sleep_start();
  }
}

/*************************************************
 * Funcion para calcular la glucosa
 *************************************************/
void calculoGlucosa() {
  glucosa = ((-526.1)*(x* x)+(1516*x)-774.5);
  //glucosaCuadratica = ((528.7) * (x * x)) - (409.6 * x) + 79.43;
  Serial.print("Glucosa (ESTIMACIÓN APROXIMADA): "); Serial.println(glucosa);
  Serial.print("Glucosa Cuadrática (ESTIMACIÓN APROXIMADA): "); Serial.println(glucosaCuadratica);
}

/*************************************************
 * Funcion para peticiones HTTP
 *************************************************/
void peticionesHTTP() {
  if (WiFi.status() == WL_CONNECTED) {
    const char* serverName = "https://monitor-glucosa-vercel.vercel.app/api/recibir_datos";
    HTTPClient http;
    http.begin(serverName);
    http.addHeader("Content-Type", "application/json");

    StaticJsonDocument<100> postData;
    
    postData["glucosa"] = glucosa;
    postData["nombre"] = userName; 
    
    String jsonString;
    serializeJson(postData, jsonString);

    Serial.print("Enviando JSON: "); Serial.println(jsonString);
    int httpResponseCode = http.POST(jsonString);

    if (httpResponseCode > 0) {
      Serial.print("Código de respuesta HTTP: ");
      Serial.println(httpResponseCode);
      String payload = http.getString();
      Serial.println("Respuesta del servidor: " + payload);
    } else {
      Serial.print("Error en la petición HTTP: ");
      Serial.println(httpResponseCode);
    }
    http.end();
  }
}

// ================================================================= //
//               9. FUNCIONES DE ENTRADA Y TEMPORIZADOR
// ================================================================= //

/*************************************************
 * Debounce para push
 *************************************************/
void checkDebounceButton() {
  if (!digitalRead(push)) {
    if (!lastDebounceTime) lastDebounceTime = millis();
    if (millis() - lastDebounceTime > 100) buttonState = true;
  } else {
    lastDebounceTime = 0;
    buttonState = false;
    if (banderaProceso) {
      START = true;
      banderaProceso = false;
    } else {
      // Mostrar logo
      display.clearDisplay();
      display.drawBitmap(0, 0, glucoStream, 128, 32, 1);
      display.display();
    }
    displayTimer = 0;
  }
}

/*************************************************
 * timer general
 *************************************************/
void timer() {
  if (millis() - tiempoActual >= 1000) {
    tiempoActual = millis();
    if (buttonState) {
      displayTimer++;
    }
    if(sleepTimer){
      sleepTimer--;
    }else{
      display.clearDisplay();
      display.display();
      esp_deep_sleep_start();
    }
  }
}


// ================================================================= //
//               10. FUNCIONES DE WIFI Y SERVIDOR WEB
// ================================================================= //

/*************************************************
 * Manejador de eventos de WebSocket
 *************************************************/
void onWebSocketEvent(AsyncWebSocket *server, AsyncWebSocketClient *client, AwsEventType type, void *arg, uint8_t *data, size_t len) {
  switch (type) {
    case WS_EVT_CONNECT:
      Serial.printf("Cliente WebSocket #%u conectado\n", client->id());
      client->text(getUserDataJson()); // Enviar datos guardados al cliente
      break;
    case WS_EVT_DISCONNECT:
      Serial.printf("Cliente WebSocket #%u desconectado\n", client->id());
      break;
    case WS_EVT_DATA: {
      AwsFrameInfo *info = (AwsFrameInfo*)arg;
      if (info->final && info->index == 0 && info->len == len && info->opcode == WS_TEXT) {
        data[len] = 0;
        Serial.printf("Datos recibidos: %s\n", (char*)data);
        
        StaticJsonDocument<200> doc;
        DeserializationError error = deserializeJson(doc, (char*)data);
        if (error) {
          Serial.println(error.c_str());
          return;
        }

        if (doc["type"] == "updateUser") {
          String newName = doc["userName"];
          String newPassword = doc["userPassword"];
          String newSSID = doc["userSSID"];
          
          saveUserData(newName, newPassword, newSSID); // Guardar en EEPROM
          ws.textAll(getUserDataJson()); 
          
          EEPROM.writeBool(ADDR_MODO, false);
          EEPROM.commit();
          ESP.restart();
        }
      }
      break;
    }
    case WS_EVT_PONG:
    case WS_EVT_ERROR:
      break;
  }
}


// ================================================================= //
//               11. FUNCIONES DE MANEJO DE DATOS (EEPROM)
// ================================================================= //

/*************************************************
 * Carga los datos de usuario desde la EEPROM
 *************************************************/
void loadUserData() {
  Serial.println("Cargando datos desde EEPROM...");
  userName = EEPROM.readString(ADDR_NAME);
  userPassword = EEPROM.readString(ADDR_PASSWORD);
  userSSID = EEPROM.readString(ADDR_SSID);

  // Asignar valores por defecto si la EEPROM está vacía
  if (userName.length() == 0) userName = "N/A";
  if (userPassword.length() == 0) userPassword = "N/A";
  if (userSSID.length() == 0) userSSID = "N/A";
}

/*************************************************
 * Guarda los datos de usuario en la EEPROM
 *************************************************/
void saveUserData(String name, String password, String ssid) {
  Serial.println("Guardando datos en EEPROM...");
  EEPROM.writeString(ADDR_NAME, name);
  EEPROM.writeString(ADDR_PASSWORD, password);
  EEPROM.writeString(ADDR_SSID, ssid);
  EEPROM.commit();
  Serial.println("Datos de usuario guardados en EEPROM.");
  
  // Actualizar las variables globales
  userName = name;
  userPassword = password;
  userSSID = ssid;
}

/*************************************************
 * Devuelve un JSON con los datos del usuario
 *************************************************/
String getUserDataJson() {
  StaticJsonDocument<200> doc;
  doc["userName"] = userName;
  doc["userPassword"] = userPassword;
  doc["userSSID"] = userSSID;
  String output;
  serializeJson(doc, output);
  return output;
}